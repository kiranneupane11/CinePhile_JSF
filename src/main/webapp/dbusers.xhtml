<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="/admintemplate.xhtml">
        <f:metadata>
            <f:event type="preRenderView" listener="#{authenticationBean.checkAdminAccess}"/>
        </f:metadata>
        <ui:define name="title">All Users</ui:define>
        
        <ui:define name="head">
            <h:outputStylesheet library="primefaces" name="theme.css"/>
        </ui:define>
        
        <ui:define name="content">
            <h:form id="main">
                <p:growl id="messages" showDetail="true" />
                <p:dataTable id="users" var="user" value="#{userBean.allUsers}" 
                     styleClass="products-table" paginator="true" rows="5" paginatorPosition="bottom">
            <f:facet name="header">
                <div class="users-table-header">
                    <span style="font-weight: bold">USERS</span>
                </div>
            </f:facet>
            
            <p:column headerText="ID" sortBy="#{user.id}" filterBy="#{user.id}">
                <h:outputText value="#{user.id}" />
            </p:column>
            
            <p:column headerText="Username" sortBy="#{user.username}" filterBy="#{user.username}">
                <h:outputText value="#{user.username}" />
            </p:column>

            <p:column headerText="Email" sortBy="#{user.email}" filterBy="#{user.email}">
                <h:outputText value="#{user.email}" />
            </p:column>
            
            <p:column headerText="Role" sortBy="#{user.role}" filterBy="#{user.role}">
                <h:outputText value="#{user.role}" />
            </p:column>
            
            <p:column exportable="false" headerText="Actions">
                <h:panelGroup layout="block"
                          style="display: flex; justify-content: center; gap: 1rem;">
                <p:commandButton icon="pi pi-pencil"
                         title="Edit Role"
                         actionListener="#{userBean.openEdit(user)}"
                         update=":main:editUserDialog"
                         oncomplete="PF('editUserDialog').show()"
                         process="@this" />
                <p:commandButton class="ui-button-warning rounded-button" icon="pi pi-trash" update=":main:messages :main:users"
                                 oncomplete="PF('deleteUserDialog').show()"
                                 actionListener="#{userBean.prepareDelete(user)}" process="@this" />
                </h:panelGroup>
            </p:column>
        </p:dataTable>
                
                <p:dialog id="editUserDialog"
                        widgetVar="editUserDialog"
                        header="Edit User Role"
                        modal="true"
                        dynamic="true">
                <h:panelGrid columns="2" cellpadding="5">
                  <h:outputLabel for="username" value="Username:" />
                  <h:outputText id="username" value="#{userBean.selectedUser.username}" />

                  <h:outputLabel for="role" value="Role:" />
                  <p:selectOneMenu id="role"
                                   value="#{userBean.selectedUser.role}"
                                   required="true"
                                   requiredMessage="Please choose a role">
                    <f:selectItem itemLabel="USER" itemValue="USER" />
                    <f:selectItem itemLabel="ADMIN" itemValue="ADMIN" />
                  </p:selectOneMenu>
                </h:panelGrid>

                <f:facet name="footer">
                  <p:commandButton value="Save"
                                   icon="pi pi-check"
                                   actionListener="#{userBean.saveUser}"
                                   process="@form"
                                   update=":main:messages :main:users"
                                   oncomplete="PF('editUserDialog').hide()" />
                  <p:commandButton value="Cancel"
                                   icon="pi pi-times"
                                   onclick="PF('editUserDialog').hide()"
                                   type="button"
                                   styleClass="ui-button-secondary"/>
                </f:facet>
              </p:dialog>
                
                <p:confirmDialog widgetVar="deleteUserDialog" showEffect="fade" width="300"
                    message="Delete User Permanently?" header="Confirm" severity="warn">
                    <p:commandButton value="Yes" icon="pi pi-check" actionListener="#{userBean.confirmDelete()}"
                        process="@this" update=":main:messages :main:users" oncomplete="PF('deleteUserDialog').hide()" />
                    <p:commandButton value="No" type="button" styleClass="ui-button-secondary" icon="pi pi-times"
                        onclick="PF('deleteUserDialog').hide()" />
                </p:confirmDialog>

        <p:confirmDialog global="true" showEffect="fade" width="300">
            <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary"
                icon="pi pi-times" />
        </p:confirmDialog>
    </h:form>
    </ui:define>
    </ui:composition>
</html>
        