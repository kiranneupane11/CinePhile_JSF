<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="/template.xhtml">
        
        <ui:define name="title">List Manager</ui:define>
        
        <ui:define name="head">
            <h:outputScript>
                window.onload = function() {
                    history.replaceState(null, document.title, window.location.pathname);
                };
            </h:outputScript>
            <h:outputStylesheet library="primefaces" name="theme.css"/>
            <style>
                .right-column-content {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    width: 100%;
                }
            </style>
        </ui:define>
        
        <ui:define name="content">
            <f:metadata>
                <f:viewParam name="movieId" value="#{playlistBean.movieId}" />
                <f:viewAction action="#{playlistBean.loadSelectedMovie()}" />
            </f:metadata>

            <p:growl id="growl" showDetail="true"/>

            <div class="card">
                <p:tabView id="playlistTabView" value="#{playlistBean.playlistsWithMovies}" var="playlistWrapper" cache="false" dynamic="true">
                    <p:ajax event="tabChange" listener="#{playlistBean.onTabChange}" update="playlistTabView" />
                    <p:tab id="playlistTab" title="#{playlistWrapper.listName}">
                        <ui:repeat value="#{playlistWrapper.movies}" var="usermovieRating">
                            <p:panel style="margin-bottom: 10px;">
                                <p:row>
                                    <p:column styleClass="ui-g-3" style="text-align: left; vertical-align: top;">
                                        <h:graphicImage value="#{usermovieRating.imageUrl}" style="width: 100px; height: 150px; display: block;" />
                                    </p:column>
                                    <p:column styleClass="ui-g-6" style="vertical-align: top;">
                                        <h3>#{usermovieRating.title}</h3>
                                        <p>#{usermovieRating.description}</p>
                                        <p><strong>Genre:</strong> #{usermovieRating.genre}</p>
                                        <p:rating readonly="true" value="#{usermovieRating.ratingAsInt}" stars="10"
                                                  rendered="#{playlistWrapper.listName eq 'Watched' or playlistWrapper.listName eq 'Dropped'}"/>
                                    </p:column>
                                    <p:column styleClass="ui-g-3" style="vertical-align: top;">
                                        <h:panelGroup styleClass="right-column-content">
                                            <p:commandButton value="Remove"
                                                             icon="pi pi-trash"
                                                             action="#{playlistBean.removeMovieFromPlaylist(playlistWrapper, usermovieRating)}"
                                                             update=":mainForm:playlistTabView :mainForm:growl :mainForm:playlistTabView:playlistTab" 
                                                             styleClass="ui-button-danger" 
                                                             process="@form" />
                                            <p:commandButton value="Edit" 
                                                            icon="pi pi-pencil"
                                                            action="#{playlistBean.editMovieFromPlaylist(playlistWrapper, usermovieRating)}"
                                                            update=":mainForm:editDialog" 
                                                            oncomplete="PF('editDialog').show()"
                                                            styleClass="ui-button-info" />
                                        </h:panelGroup>
                                    </p:column>
                                </p:row>
                            </p:panel>
                        </ui:repeat>
                    </p:tab>
                </p:tabView>
            </div>

            <p:dialog id="addToListDialog" widgetVar="addToListDialog" header="Add Movie to List" modal="true" appendTo="@(body)" resizable="false" visible="false" dynamic="true">
                <h:form id="addToListDialogForm">
                    <h:outputText value="Movie ID: #{playlistBean.movieId}" />
                    <h:outputText value="Selected Movie: #{playlistBean.selectedMovie != null ? playlistBean.selectedMovie.title : 'null'}" />
                    <h:panelGroup layout="block" style="text-align: center; margin-bottom: 15px;">
                        <h:graphicImage value="#{playlistBean.selectedMovie.imageUrl}" 
                                      style="width: 100px; height: 150px; display: block; margin: 0 auto;" 
                                      rendered="#{not empty playlistBean.selectedMovie.imageUrl}"/>
                        <h:outputText value="#{playlistBean.selectedMovie.title}" 
                                    style="font-size: 18px; font-weight: bold; display: block; margin-top: 10px;" 
                                    rendered="#{not empty playlistBean.selectedMovie}"/>
                    </h:panelGroup>
                    
                    <h:panelGrid columns="2" style="margin-bottom: 10px; padding: 10px; width: 100%;">              
                        <h:outputText value="Status:" />
                        <p:selectOneRadio id="status" value="#{playlistBean.status}" layout="grid" columns="2">
                            <f:selectItem itemLabel="Watching" itemValue="Watching" />
                            <f:selectItem itemLabel="Watched" itemValue="Watched" />
                            <f:selectItem itemLabel="Plan to Watch" itemValue="Plan_To_Watch" />
                            <f:selectItem itemLabel="Dropped" itemValue="Dropped" />
                            <p:ajax update="addRatingContainer" />
                        </p:selectOneRadio>

                        <h:panelGroup id="addRatingContainer">
                            <h:outputText value="Rating:" rendered="#{playlistBean.status eq 'Watched' or playlistBean.status eq 'Dropped'}" />
                            <p:panel id="ratingPanel" style="margin: 0; padding: 0;"
                                     rendered="#{playlistBean.status eq 'Watched' or playlistBean.status eq 'Dropped'}">
                                 <p:rating value="#{playlistBean.ratingAsInt}" stars="10" cancel="false" />
                            </p:panel>
                        </h:panelGroup>
                    </h:panelGrid>
                    <p:commandButton value="Add" action="#{playlistBean.addToList}" 
                                     oncomplete="PF('addToListDialog').hide()" update=":mainForm:growl, :mainForm:playlistTabView" process="@form" />
                </h:form>
            </p:dialog>
            
            <p:dialog id="editDialog" widgetVar="editDialog" header="Edit Movie in List" modal="true" resizable="false" appendTo="@(body)" visible="false">
                <h:form id="editDialogForm">
                    <h:panelGroup layout="block" style="text-align: center; margin-bottom: 15px;">
                        <h:graphicImage value="#{playlistBean.selectedMovie.imageUrl}" 
                                      style="width: 100px; height: 150px; display: block; margin: 0 auto;" 
                                      rendered="#{playlistBean.selectedMovie != null and playlistBean.selectedMovie.imageUrl != null}"/>
                        <h:outputText value="#{playlistBean.selectedMovie.title}" 
                                    style="font-size: 18px; font-weight: bold; display: block; margin-top: 10px;" 
                                    rendered="#{playlistBean.selectedMovie != null}"/>
                    </h:panelGroup>

                    <h:panelGrid columns="2" style="margin-bottom: 10px; padding: 10px; width: 100%;">              
                        <h:outputText value="Status:" />
                        <p:selectOneRadio id="editStatus" value="#{playlistBean.status}" layout="grid" columns="2">
                            <f:selectItem itemLabel="Watching" itemValue="Watching" />
                            <f:selectItem itemLabel="Watched" itemValue="Watched" />
                            <f:selectItem itemLabel="Plan to Watch" itemValue="Plan_To_Watch" />
                            <f:selectItem itemLabel="Dropped" itemValue="Dropped" />
                            <p:ajax update="editRatingContainer" />
                        </p:selectOneRadio>

                        <h:panelGroup id="editRatingContainer">
                            <h:outputText value="Rating:" rendered="#{playlistBean.status eq 'Watched' or playlistBean.status eq 'Dropped'}" />
                            <p:panel id="editRatingPanel" style="margin: 0; padding: 0;" 
                                     rendered="#{playlistBean.status eq 'Watched' or playlistBean.status eq 'Dropped'}">
                                <p:rating value="#{playlistBean.ratingAsInt}" stars="10" cancel="false" />
                            </p:panel>
                        </h:panelGroup>
                    </h:panelGrid>
                    <p:commandButton value="Save" action="#{playlistBean.updateMovieInList}" update=":mainForm:growl, :mainForm:playlistTabView" 
                                   oncomplete="PF('editDialog').hide()" process="@form" />
                </h:form>
            </p:dialog>  

            <h:outputScript>
                $(document).ready(function() {
                    if (#{not empty playlistBean.movieId}) {
                        PF('addToListDialog').show();
                    }
                });
            </h:outputScript>
        </ui:define>
    </ui:composition>
</html>