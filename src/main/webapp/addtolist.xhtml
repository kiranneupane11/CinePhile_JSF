<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="/template.xhtml">
        
        <ui:define name="title">List Manager</ui:define>
        
        <ui:define name="head">
            <h:outputScript>
                window.onload = function() {
                    history.replaceState(null, document.title, window.location.pathname);
                };
            </h:outputScript>
            <h:outputStylesheet library="primefaces" name="theme.css"/>
            <style>
                .right-column-content {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    width: 100%;
                }
            </style>
        </ui:define>
        
        <ui:define name="content">
            <h:form>
            <f:metadata>
                <f:viewParam name="movieId" value="#{playlistBean.movieId}" />
                <f:viewAction action="#{playlistBean.loadSelectedMovie()}" />
            </f:metadata>
            </h:form>
            
            <p:growl id="growl" showDetail="true"/>
            
     <div class="card">
    <p:tabView id="playlistTabView" 
               value="#{playlistBean.playlists}" 
               var="playlistWrapper" 
               cache="false" 
               dynamic="true" 
               widgetVar="playlistTV">
        
        <p:ajax event="tabChange"
                listener="#{playlistBean.onTabChange}"
                update="playlistTabView" />
        
        <p:tab id="playlistTab" title="#{playlistWrapper.listName}">
            
            <p:toolbar style="margin-bottom:0.5rem;">
                    <p:toolbarGroup align="right">
                        <p:commandButton icon="#{playlistBean.gridView ? 'pi pi-bars' : 'pi pi-th-large'}"
                                         title="Switch View"
                                         action="#{playlistBean.toggleView}"
                                         update="tabContent pagingControls"
                                         process="@this"/>
                    </p:toolbarGroup>
                </p:toolbar>
            
            <!-- Pass the playlist id for lazy loading -->
            <f:attribute name="playlistId" value="#{playlistWrapper.playlistId}" />

            <!-- GRID CONTAINER -->
            <h:panelGroup id="tabContent" layout="block">
            <ui:fragment rendered="#{playlistBean.gridView}">
            <div style="display: grid;
                 grid-template-columns: #{playlistBean.gridView ? 'repeat(3, 1fr)' : '1fr'};
                 gap: 1rem;
                 justify-items: center; 
                 align-items: flex-start;">
                
                <!-- Repeat over each movie item -->
                <ui:repeat value="#{playlistWrapper.movies}" var="usermovieRating">
                    
                    <!-- Grid View -->
                    <p:panel style="
                            width: 90%; /* ensures a consistent width per cell */
                            min-height: 400px; /* give enough vertical space */
                            box-sizing: border-box;
                            border: 1px solid #444; /* or remove border */
                            border-radius: 4px; /* optional rounding */
                            padding: 1rem;
                            background: #222; /* match your theme, or remove */
                            color: #fff;       
                        "
                    >

                        <p:row>
                            <p:column styleClass="ui-g-12" style="text-align:center;">
                                <!-- Movie poster -->
                                <h:graphicImage value="#{usermovieRating.imageUrl}"
                                                style="width: 100px; 
                                                       height: 150px; 
                                                       display: block; 
                                                       margin: 0 auto;" />
                            </p:column>

                            <p:column styleClass="ui-g-12">
                                <!-- Title -->
                                <h3 style="margin: 0.5rem 0;">
                                    #{usermovieRating.title}
                                </h3>
                                <!-- Description -->
                                <p style="margin: 0.5rem 0;">
                                    #{usermovieRating.description}
                                </p>
                                <!-- Genre -->
                                <h:outputText styleClass="genre-item"
                                              value="#{usermovieRating.genre}"
                                              style="margin-bottom:0.5rem;" />
                                <!-- Rating -->
                                <p:rating readonly="true" 
                                          value="#{usermovieRating.ratingAsInt}" 
                                          stars="10"
                                          styleClass="rating-value" 
                                          style="margin-bottom: 0.5rem;"
                                          rendered="#{playlistWrapper.listName eq 'Watched' 
                                                   or playlistWrapper.listName eq 'Dropped'}"/>
                                <!-- Spacing placeholder if rating not shown -->
                                <h:outputText value=" "
                                              rendered="#{not (playlistWrapper.listName eq 'Watched' 
                                                             or playlistWrapper.listName eq 'Dropped')}"
                                              style="display: block; height: 1.5rem;" />
                            </p:column>

                            <h:panelGroup layout="block" style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                                <!-- Action buttons: Remove, Edit -->
                                <p:commandButton icon="pi pi-trash"
                                                 action="#{playlistBean.prepareRemoveDialog(playlistWrapper, usermovieRating)}"
                                                 oncomplete="PF('removeDialog').show()"
                                                 update=":mainForm:removeDialogForm,
                                                 :mainForm:playlistTabView, 
                                                 :mainForm:playlistTabView:playlistTab,
                                                 :mainForm:growl"
                                                 styleClass="ui-button-danger" 
                                                 process="@this" 
                                                 style="display: inline-block;" />

                                <p:commandButton icon="pi pi-pencil"
                                                 action="#{playlistBean.prepareEditMovie(playlistWrapper, usermovieRating)}"
                                                 update=":mainForm:editDialogForm, 
                                                         :mainForm:playlistTabView, 
                                                         :mainForm:playlistTabView:playlistTab, 
                                                         :mainForm:growl" 
                                                 oncomplete="PF('editDialog').show()"
                                                 styleClass="ui-button-info"
                                                 process="@this" 
                                                 style="display: inline-block;" />
                            </h:panelGroup>
                        </p:row>
                </p:panel>
            </ui:repeat>                     
        </div>
    </ui:fragment>
                                   <!-- LIST VIEW -->
                    <ui:fragment rendered="#{not playlistBean.gridView}">
                        <div class="ui-g" style="width: 100%">
                            <ui:repeat value="#{playlistWrapper.movies}" var="usermovieRating">
                                <div class="ui-g-12 list-view-row">
                                    <div class="ui-g-2" style="text-align: center;">
                                        <h:graphicImage value="#{usermovieRating.imageUrl}" 
                                                      style="width: 80px; height: 120px;"/>
                                    </div>
                                    <div class="ui-g-2" style="display: flex; align-items: center;">
                                        <h:outputText value="#{usermovieRating.title}" 
                                                     style="font-weight: bold;"/>
                                    </div>
                                    <div class="ui-g-1" styleClass="genre-item" style="display: flex; align-items: center;">
                                        <h:outputText value="#{usermovieRating.genre}"/>
                                    </div>
                                    <div class="ui-g-3" style="display: flex; align-items: center;">
                                        <h:outputText value="#{usermovieRating.description}" 
                                                     style="max-height: 60px; overflow: hidden;"/>
                                    </div>
                                    <div class="ui-g-2" style="display: flex; align-items: center;">
                                        <p:rating readonly="true" 
                                                 value="#{usermovieRating.ratingAsInt}"
                                                 stars="10"
                                                 rendered="#{playlistWrapper.listName eq 'Watched' or playlistWrapper.listName eq 'Dropped'}"/>
                                    </div>
                                    <div class="ui-g-2" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                                        <p:commandButton icon="pi pi-trash"
                                                       action="#{playlistBean.prepareRemoveDialog(playlistWrapper, usermovieRating)}"
                                                       update=":mainForm:removeDialogForm,
                                                               :mainForm:playlistTabView, 
                                                               :mainForm:playlistTabView:playlistTab, 
                                                               :mainForm:growl"
                                                       oncomplete="PF('removeDialog').show()"
                                                       process="@this"
                                                       styleClass="ui-button-danger"/>
                                        <p:commandButton icon="pi pi-pencil"
                                                       action="#{playlistBean.prepareEditMovie(playlistWrapper, usermovieRating)}"
                                                       update=":mainForm:editDialogForm,
                                                               :mainForm:playlistTabView, 
                                                               :mainForm:playlistTabView:playlistTab, 
                                                               :mainForm:growl"
                                                       oncomplete="PF('editDialog').show()"
                                                       process="@this"
                                                       styleClass="ui-button-info"/>
                                    </div>
                                </div>
                </ui:repeat>
            </div>
        </ui:fragment>
    </h:panelGroup>

        <h:panelGroup id="pagingControls" layout="block" style="text-align:center;margin-top:1rem;">
            <!-- Load More button -->
            <p:commandButton value="Load More" icon="pi pi-angle-down"
                     action="#{playlistBean.loadNextPage(playlistWrapper.playlistId)}"
                     update="tabContent pagingControls"
                     process="@this"
                     rendered="#{playlistWrapper.hasMore}"
                     styleClass="ui-button-secondary" />

            <!-- Load Less Button -->
            <p:commandButton value="Load Less" icon="pi pi-angle-up"
                             action="#{playlistBean.loadLess(playlistWrapper.playlistId)}"
                             update="tabContent pagingControls"
                             process="@this"
                             rendered="#{playlistWrapper.expanded}"
                             styleClass="ui-button-secondary" />
        </h:panelGroup>
        </p:tab>
    </p:tabView>
</div>

            <p:dialog id="addToListDialog" widgetVar="addToListDialog" header="Add Movie to List" modal="true" appendTo="@(body)" resizable="false" visible="false" dynamic="true">
                <h:form id="addToListDialogForm">
                    <h:panelGroup layout="block" style="text-align: center; margin-bottom: 15px;">
                        <h:graphicImage value="#{playlistBean.selectedMovie.imageUrl}" 
                                      style="width: 100px; height: 150px; display: block; margin: 0 auto;" 
                                      rendered="#{not empty playlistBean.selectedMovie.imageUrl}"/>
                        <h:outputText value="#{playlistBean.selectedMovie.title}" 
                                    style="font-size: 18px; font-weight: bold; display: block; margin-top: 10px;" 
                                    rendered="#{not empty playlistBean.selectedMovie}"/>
                    </h:panelGroup>
                    
                    <h:panelGrid columns="2" style="margin-bottom: 10px; padding: 10px; width: 100%;">              
                        <h:outputText value="Status:" />
                        <p:selectOneRadio id="status" value="#{playlistBean.status}" layout="grid" columns="2">
                            <f:selectItem itemLabel="Watching" itemValue="Watching" />
                            <f:selectItem itemLabel="Watched" itemValue="Watched" />
                            <f:selectItem itemLabel="Plan to Watch" itemValue="Plan_To_Watch" />
                            <f:selectItem itemLabel="Dropped" itemValue="Dropped" />
                            <p:ajax update="addRatingContainer" />
                        </p:selectOneRadio>

                        <h:panelGroup id="addRatingContainer">
                            <h:outputText value="Rating:" rendered="#{playlistBean.status eq 'Watched' or playlistBean.status eq 'Dropped'}" />
                            <p:panel id="ratingPanel" style="margin: 0; padding: 0;"
                                     rendered="#{playlistBean.status eq 'Watched' or playlistBean.status eq 'Dropped'}">
                                 <p:rating value="#{playlistBean.ratingAsInt}" stars="10" cancel="false" />
                            </p:panel>
                        </h:panelGroup>
                    </h:panelGrid>
                    <p:commandButton value="Add" action="#{playlistBean.addToList}" 
                                     oncomplete="PF('addToListDialog').hide()" update=":mainForm:growl, :mainForm:playlistTabView" process="@form" />
                </h:form>
            </p:dialog>
            
           <p:dialog id="editDialog" widgetVar="editDialog" header="Edit Movie in List" modal="true" resizable="false" appendTo="@(body)" visible="false">
            <h:form id="editDialogForm">
            <h:panelGroup layout="block" style="text-align: center; margin-bottom: 15px;">
                <h:graphicImage value="#{playlistBean.editMovie.imageUrl}" 
                              style="width: 100px; height: 150px; display: block; margin: 0 auto;" 
                              rendered="#{playlistBean.editMovie != null and playlistBean.editMovie.imageUrl != null}"/>
                <h:outputText value="#{playlistBean.editMovie.title}" 
                              style="font-size: 18px; font-weight: bold; display: block; margin-top: 10px;" 
                              rendered="#{playlistBean.editMovie != null}"/>
            </h:panelGroup>
            <h:panelGrid columns="2" style="margin-bottom: 10px; padding: 10px; width: 100%;">
                <h:outputText value="Status:" />
                <p:selectOneRadio id="editStatus" value="#{playlistBean.editStatus}" layout="grid" columns="2">
                    <f:selectItem itemLabel="Watching" itemValue="Watching" />
                    <f:selectItem itemLabel="Watched" itemValue="Watched" />
                    <f:selectItem itemLabel="Plan to Watch" itemValue="Plan_To_Watch" />
                    <f:selectItem itemLabel="Dropped" itemValue="Dropped" />
                    <p:ajax update="editRatingContainer" />
                </p:selectOneRadio>
                <h:panelGroup id="editRatingContainer">
                    <h:outputText value="Rating:" rendered="#{playlistBean.editStatus eq 'Watched' or playlistBean.editStatus eq 'Dropped'}" />
                    <p:panel id="editRatingPanel" style="margin: 0; padding: 0;" 
                             rendered="#{playlistBean.editStatus eq 'Watched' or playlistBean.editStatus eq 'Dropped'}">
                        <p:rating value="#{playlistBean.editRating}" stars="10" cancel="false" />
                    </p:panel>
                </h:panelGroup>
            </h:panelGrid>
            <p:commandButton value="Save" action="#{playlistBean.updateEditMovieInList}" 
                             update=":mainForm:playlistTabView :mainForm:growl" 
                             oncomplete="PF('editDialog').hide()" process="@form" />
        </h:form>
        </p:dialog>
            
            <p:dialog id="removeDialog" widgetVar="removeDialog" header="Confirm Removal" modal="true" resizable="false" appendTo="@(body)" >
                <h:form id="removeDialogForm">
                    <h:outputText value="Are you sure you want to remove  " />
                    <br/><br/>
                    <h:graphicImage value="#{playlistBean.removeMovieRating.imageUrl}" 
                                      style="width: 100px; height: 150px; display: block; margin: 0 auto;" 
                                      rendered="#{not empty playlistBean.removeMovieRating.imageUrl}"/>
                        <h:outputText value="#{playlistBean.removeMovieRating.title}" 
                                    style="font-size: 18px; font-weight: bold; display: block; margin-top: 10px;" 
                                    rendered="#{not empty playlistBean.removeMovieRating}"/>
                    <h:outputText value=" from " />
                    <h:outputText value="#{playlistBean.removePlaylistWrapper.listName}" style="font-weight:bold;" />
                    <br/><br/>
                    <p:commandButton value="Yes" action="#{playlistBean.confirmRemove}" 
                                     update=":mainForm:playlistTabView, :mainForm:growl " 
                                     oncomplete="PF('removeDialog').hide()" process="@form" />
                    <p:commandButton value="No" onclick="PF('removeDialog').hide();" type="button" />
                </h:form>
            </p:dialog>


           <h:outputScript>
            setTimeout(function() {
                // Ensure that playlistBean.movieId is not null
                if(#{playlistBean.movieId != null}) {
                    PF('addToListDialog').show();
                }
            }, 100); 
        </h:outputScript>

        </ui:define>
    </ui:composition>
</html>