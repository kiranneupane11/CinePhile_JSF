<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<h:head>
    <title>Available Movies</title>
    <h:outputStylesheet library="css" name="movie-card.css" />
    <h:outputStylesheet library="css" name="movie-details.css" />
    <h:outputScript library="js" name="overlay.js" />
</h:head>
<h:body>
    <h3>Top Rated Movies</h3>
    <h:form id="mainForm">
        <!-- Search bar -->
        <p:inputText id="searchTerm" value="#{movieViewBean.searchTerm}" placeholder="Search movies, lists...">
            <f:ajax event="keyup" render="movieGrid" listener="#{movieViewBean.searchMovies}" />
        </p:inputText>
        <p:commandButton value="Search" action="#{movieViewBean.searchMovies}" update="movieGrid" />

        <p:panel rendered="#{not authenticationBean.loggedIn}">
            <p:button value="Login" outcome="/login.xhtml"/>
            <p:button value="Sign Up" outcome="/signup.xhtml"/>
        </p:panel>

        <p:panel rendered="#{authenticationBean.loggedIn}">
            <h:outputText value="Welcome, #{authenticationBean.username}!"/>
            <p:commandButton value="LogOut" action="#{authenticationBean.logout}" update="@form" />
        </p:panel>

        <!-- DataGrid for movie cards -->
        <p:dataGrid id="movieGrid" value="#{movieViewBean.filteredMovies}" var="movie" columns="5" layout="grid" styleClass="movie-grid">
            <p:panel styleClass="movie-card">
                <p:commandLink action="#{movieViewBean.selectMovie(movie)}"
                               update=":mainForm:dialogContent"
                               oncomplete="setOverlayBackground('#{movie.imageUrl}'); PF('movieDialog').show();"
                               onerror="alert('AJAX error')">
                    <p:graphicImage value="#{movie.imageUrl}" styleClass="movie-poster" alt="Movie Poster" />
                    <div class="movie-card-content">
                        <h:outputText value="#{movie.title}" styleClass="movie-title" />
                    </div>
                </p:commandLink>
            </p:panel>
        </p:dataGrid>

        <!-- Dialog to display selected movie details -->
        <p:dialog id="movieDialog" 
                  widgetVar="movieDialog" 
                  header="Movie Details" 
                  modal="true" 
                  resizable="false" 
                  appendTo="@(body)"
                  onHide="$('.ui-widget-overlay').css('background','');">
            <p:outputPanel id="dialogContent">
                <div class="surface-section">
                    <div class="font-medium text-3xl text-900 mb-3">Movie Details</div>
                    <h:panelGroup styleClass="details-container">
                        <ui:repeat value="#{movieViewBean.movieDetails}" var="detail">
                            <div class="detail-item #{detail.key == 'Description' ? 'border-top-1 border-bottom-1' : 'border-top-1'} surface-border">
                                <span class="label text-500 font-medium">#{detail.key}</span>
                                <span class="value text-900">
                                    <h:outputText value="#{detail.value}"
                                                  rendered="#{detail.key != 'Rating' and detail.key != 'Description' and detail.key != 'Genre'}" />
                                    <h:outputText value="#{detail.value}" rendered="#{detail.key == 'Description'}" styleClass="line-height-3" />
                                    <h:panelGroup rendered="#{detail.key == 'Rating'}" layout="block" styleClass="rating-container">
                                        <p:rating value="#{movieViewBean.selectedMovieRatingAsInt}" stars="10" cancel="false" readonly="true" />
                                        <h:outputText value=" (#{detail.value})" styleClass="rating-value" />
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{detail.key == 'Genre'}" layout="block" styleClass="genre-container">
                                        <h:dataTable value="#{movieViewBean.selectedMovie.genre.split(',')}" var="genre" styleClass="genre-table">
                                            <h:column>
                                                <h:outputText value="#{genre.trim()}" styleClass="genre-item"/>
                                            </h:column>
                                        </h:dataTable>
                                    </h:panelGroup>
                                </span>
                            </div>
                        </ui:repeat>
                    </h:panelGroup>
                    <div class="text-center mt-4">
                        <p:button value="Add to List" 
                                  outcome="#{authenticationBean.loggedIn ? '/addtolist.xhtml' : '/login.xhtml'}"
                                  styleClass="add-to-list-button" />
                    </div>
                </div>
            </p:outputPanel>
        </p:dialog>
    </h:form>
</h:body>
</html>